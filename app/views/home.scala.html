@()(implicit messages: Messages)

@siteTemplate("Homepage") {

    <!-- Contains all raised elements-->
    <div class="container-fluid">

            <!-- Summary data -->
        <div class="row small-margin-bottom data-blocks">

                <!-- Total hours studied -->
            <div class="col-sm-offset-1 col-sm-2 raised-element">
                <u class="data-block-title">Total</u><br>
                <span id="total-value" class="introMessageValue"></span> hours
            </div>

                <!-- Hours studied today vs. average -->
            <div class=" col-sm-offset-1 col-sm-4 raised-element">
                <u class="data-block-title">Today / Average</u><br>
                <span id="today-value" class="introMessageValue"></span>
                / <span id="average-value" class="introMessageValue"></span>
            </div>

                <!-- Length of the current streak -->
            <div class=" col-sm-offset-1 col-sm-2 raised-element">
                <u class="data-block-title">Current Streak</u><br>
                <span id="streak-value" class="introMessageValue"></span> days
            </div>
        </div>

            <!-- Today's sessions plot -->
        <div id="widt-row" class="row small-margin-bottom">
            <div id="widt" class="col-sm-offset-1 col-sm-10 raised-element">
                <div id="todaysSessionsPlot" class="loading-icon">
                    <span class="fa fa-4x fa-circle-o-notch fa-spin"></span>
                </div>
            </div>
        </div>

            <!-- Cumulative hours studied plot-->
        <div class="row">
            <div class="col-sm-offset-1 col-sm-10 raised-element padded-plot spaced-plot">
                <div id="cumulativePlot" class="googlePlotContainer loading-icon">
                    <span class="fa fa-4x fa-circle-o-notch fa-spin"></span>
                </div>
            </div>
        </div>

            <!-- Subject totals plot-->
        <div class="row">
            <div class="col-sm-offset-1 col-sm-10 raised-element padded-plot spaced-plot">
                <div id="subjectTotalsPlot" class="googlePlotContainer loading-icon">
                    <span class="fa fa-4x fa-circle-o-notch fa-spin"></span>
                </div>
            </div>
        </div>

            <!-- Average-day probability plot -->
        <div class="row">
            <div class="col-sm-offset-1 col-sm-10 raised-element padded-plot spaced-plot">
                <div id="probabilityPlot" class="googlePlotContainer loading-icon">
                    <span class="fa fa-4x fa-circle-o-notch fa-spin"></span>
                </div>
            </div>
        </div>

            <!-- Moving-average plot -->
        <div class="row">
            <div class="col-sm-offset-1 col-sm-10 raised-element padded-plot spaced-plot">
                <div id="movingAveragePlot" class="googlePlotContainer loading-icon">
                    <span class="fa fa-4x fa-circle-o-notch fa-spin"></span>
                </div>
            </div>
        </div>
    </div>

    <script src="@routes.Assets.at("/javascripts/loadJSON.js")"></script>
    <script src="@routes.Assets.at("/javascripts/moment.js")"></script>
    <script src="@routes.Assets.at("/javascripts/moment-timezone-10-20.js")"></script>
    <script src="@routes.Assets.at("/javascripts/stats.js")"></script>

    <script>
            //
            // Does not handle sessions longer than 24 hours
            function splitDays(sessions) {

                // Trivial case
                if (sessions.length === 0) {
                    return [];
                }

                var m = sessions.map(function (curr, i, arr) {
                    return {
                        "start": moment.tz(curr.startTime, "America/Chicago"),
                        "stop": moment.tz(curr.endTime, "America/Chicago"),
                        "subject": curr.subject
                    }
                });

                // The end of the day being handled
                var marker = m[0].start.clone().endOf('day');

                var dayGroups = [{"date": marker.clone(), "sessions": []}];

                m.forEach(function (curr, i, arr) {

                    if (curr.stop <= marker) {
                        dayGroups[dayGroups.length - 1]["sessions"].push(curr);
                    } else {

                        dayGroups[dayGroups.length - 1]["sessions"].push({
                            "start": curr.start,
                            "stop": marker.clone(),
                            "subject": curr.subject
                        });

                        dayGroups.push({
                            "date": marker.clone().add(1, 'day'),
                            "sessions": [{
                                "start": marker.clone(),
                                "stop": curr.stop,
                                "subject": curr.subject
                            }]
                        });

                        // Move to the next day
                        marker.add(1, 'day');
                    }


                });

                return dayGroups;
            }

            function sumSessions(sessions) {

                return sessions.reduce(function (acc, curr, i) {
                    return acc + ((curr.stop - curr.start) / 3600000);
                }, 0);

            }

            function sumArray(arr) {
                return arr.reduce(function (acc, curr, i) {
                    return acc + curr;
                }, 0);
            }

            function dailyAverage(dayGroups) {

                var dailies = dayGroups.map(function (curr, i, arr) {
                    return sumSessions(curr.sessions);
                });

                console.log("dailies" + dailies.toString());

                return sumArray(dailies) / dailies.length;
            }


            // TODO: Comment this function
            function stats1(sessions, numLevels) {

                var dayGroups = splitDays(sessions);

                var diff;
                var cumul = 0;

                // Total duration of completed sessions
                var total = sumRawSessions(sessions);

                var levelSize = total / numLevels;

                var level = 1;
                var res = [[new Date(sessions[0].startTime), 0]];

                sessions.forEach(function (curr, i, arr) {
                    diff = (curr.endTime - curr.startTime) / (3600 * 1000);

                    cumul += diff;

                    if (cumul >= level * levelSize) {

                        // How much the session extends past the level boundary
                        var t = (cumul - level * levelSize) * 3600 * 1000;

                        res.push([new Date(curr.endTime - t), level * levelSize]);
                        level += 1;
                    }
                });

                // Last item in cumuls
                if (res.length < numLevels + 1) {
                    res.push([new Date(sessions[sessions.length - 1].endTime), cumul]);
                }

                return {
                    "cumulative": res,
                    "total": total,
                    "dailyAverage": dailyAverage(dayGroups)
                }
            }

    </script>

    <script>

            // Load the  charts
            google.charts.load('44', {packages: ['line', 'bar', 'timeline']});

            // Get a duration as [hh, mm, ss] from seconds
            function hms(sec) {
                var h = Math.floor(sec / 3600);

                sec = sec - 3600 * h;

                var m = Math.floor(sec / 60);

                sec = sec - 60 * m;

                return [h, m, sec];
            }


            // Global plot properties
            var titleIsBold = true;
            var titleFontSize = 32;
            var hAxisFontSize = 20;
            var vAxisFontSize = 20;


            // Writes values currently computed on the backend
            function writeSummaryData(stats) {

                //document.getElementById("average-value").textContent = stats.dailyAverage.toFixed(2).toString();

                document.getElementById("streak-value").textContent = stats.currentStreak.toString();

                document.getElementById("today-value").textContent = stats.todaysTotal.toFixed(2).toString();
            }

            //
            function writeIntroMessageJS(stats) {

                document.getElementById("average-value").textContent = stats.dailyAverage.toFixed(2).toString();

                document.getElementById("total-value").textContent = Math.round(stats.total).toString();
            }


            function getTodaysSessionsPlotDrawer(sessions, elementId) {

                function tmp() {

                    var options = {
                        height: 95,
                        hAxis: {
                            title: "",
                            fontSize: 0
                        },
                        backgroundColor: "transparent",
                        groupByRowLabel: false
                    };

                    var table = new google.visualization.DataTable();

                    table.addColumn({type: "string", id: "Role"});
                    table.addColumn({type: "string", id: "Subject"});
                    table.addColumn({type: "number", id: "Start"});
                    table.addColumn({type: "number", id: "End"});


                    var rows = sessions.map(function (elem, i, self) {
                        return ["What I've Done Today", elem.subject, elem.startTime, elem.endTime];
                    });

                    table.addRows(rows);

                    var chart = new google.visualization.Timeline(document.getElementById(elementId));

                    chart.draw(table, options);
                }

                return tmp;
            }


            function getCumulativePlotDrawer(cumulativeData, elementId) {

                var options = {
                    chart: {
                        title: "Cumulative Hours Studied"
                    },
                    legend: {
                        position: 'none'
                    },
                    colors: ['green'],
                    titleTextStyle: {
                        fontSize: titleFontSize,
                        bold: titleIsBold
                    },
                    hAxis: {
                        title: "",
                        textStyle: {
                            fontSize: hAxisFontSize
                        }
                    },
                    vAxis: {
                        textStyle: {
                            fontSize: vAxisFontSize
                        }
                    },
                    backgroundColor: "transparent",
                    chartArea: {
                        backgroundColor: "transparent"
                    },
                    // Not working
                    lineWidth: 10,
                    // Not working
                    curveType: 'function'
                };

                function tmp() {

                    var columnLabels = [["Date", "Cumulative Hours Studied"]];

                    var chart = new google.charts.Line(document.getElementById(elementId));

                    var table = google.visualization.arrayToDataTable(columnLabels.concat(cumulativeData));

                    chart.draw(table, google.charts.Line.convertOptions(options));
                }

                return tmp;
            }

            function getSlidingAveragePlotDrawer(slidingAverageData, elementId) {

                var options = {
                    chart: {
                        title: "Hours Studied Per Day",
                        subtitle: "Sliding average - 31 day window"
                    },
                    legend: {
                        position: 'none'
                    },
                    colors: ['green'],
                    titleTextStyle: {
                        fontSize: titleFontSize,
                        bold: titleIsBold
                    },
                    hAxis: {
                        title: "",
                        textStyle: {
                            fontSize: hAxisFontSize
                        }
                    },
                    vAxis: {
                        textStyle: {
                            fontSize: vAxisFontSize
                        }
                    },
                    backgroundColor: "transparent",
                    chartArea: {
                        backgroundColor: "transparent"
                    },
                    // Not working
                    lineWidth: 10,
                    // Not working
                    curveType: 'function'
                };

                convertDates(slidingAverageData, 0);

                function tmp() {

                    var columnLabels = [["Date", "Average Hours Studied"]];

                    var chart = new google.charts.Line(document.getElementById(elementId));

                    var table = google.visualization.arrayToDataTable(columnLabels.concat(slidingAverageData));

                    chart.draw(table, google.charts.Line.convertOptions(options));
                }

                return tmp;
            }


            // Returns a function that will draw the SubjectTotals plot
            function getSubjectTotalsPlotDrawer(subjectTotals, elementId) {

                var options = {
                    chart: {
                        title: "Total Hours Studied Per Subject",
                        subtitle: "10 most studied subjects"
                    },
                    titleTextStyle: {
                        fontSize: titleFontSize,
                        bold: titleIsBold
                    },
                    legend: {
                        position: 'none'
                    },
                    hAxis: {
                        title: "",
                        textStyle: {
                            fontSize: hAxisFontSize
                        }
                    },
                    vAxis: {
                        textStyle: {
                            fontSize: vAxisFontSize
                        }
                    },
                    backgroundColor: "transparent",
                    chartArea: {
                        backgroundColor: "transparent"
                    },
                    bars: 'vertical',
                    colors: ['green']
                };


                function tmp() {

                    var columnLabels = [["Subject", "Total"]];

                    var chart = new google.charts.Bar(document.getElementById(elementId));

                    var table = google.visualization.arrayToDataTable(columnLabels.concat(subjectTotals));

                    chart.draw(table, google.charts.Bar.convertOptions(options));
                }

                return tmp;
            }


            function getProbabilityPlotDrawer(probabilities, elementId) {

                var options = {
                    chart: {
                        title: "Probability That I'm Programming",
                        subtitle: "at a particular time on any given day"
                    },
                    titleTextStyle: {
                        fontSize: titleFontSize,
                        bold: titleIsBold
                    },
                    legend: {
                        position: 'none'
                    },
                    hAxis: {
                        title: "",
                        textStyle: {
                            fontSize: hAxisFontSize
                        },
                        // The format string is based on ICU pattern set
                        format: "h a"
                    },
                    vAxis: {
                        textStyle: {
                            fontSize: vAxisFontSize
                        }
                    },
                    backgroundColor: "transparent",
                    chartArea: {
                        backgroundColor: "transparent"
                    },
                    lineWidth: 10,
                    colors: ['green']
                };

                function tmp() {

                    var columnLabels = [["Time", "Probability"]];

                    var dataArray = probabilities.map(function (elem, i, self) {
                        return [hms((i / self.length) * 86400), elem];
                    });

                    dataArray.forEach(function (elem, i, self) {
                        elem[0][0] += 6;
                        elem[0][0] %= 24;
                    });

                    dataArray.sort(function (a, b) {

                        if (a[0][0] < b [0][0]) {
                            return -1;
                        } else if (a[0][0] > b[0][0]) {
                            return 1;
                        } else if (a[0][1] < b[0][1]) {
                            return -1;
                        } else if (a[0][1] > b[0][1]) {
                            return 1;
                        } else if (a[0][2] < b[0][2]) {
                            return -1;
                        } else if (a[0][2] > b[0][2]) {
                            return 1;
                        } else {
                            return 0;
                        }

                    });

                    var chart = new google.charts.Line(document.getElementById(elementId));

                    var table = google.visualization.arrayToDataTable(columnLabels.concat(dataArray));

                    chart.draw(table, google.charts.Line.convertOptions(options));
                }

                return tmp;
            }

            function convertDates(plotData, column) {
                plotData.forEach(function (elem, i, self) {
                    elem[column] = new Date(elem[0]);
                });
            }


            // Moving stat computation to JS
            loadJSONFile("/json/sessions/jgdodson", function (data) {

                // The current time could come from the timestamp in the ResultInfo...
                if (data.status.isStudying) {
                    data.sessions.push({
                        "subject": data.status.subject,
                        "startTime": data.status.start,
                        "endTime": new Date().getTime()
                    });
                }

                console.log(data.sessions);

                console.log(splitDays(data.sessions));

                console.log(data.sessions);

                var s1 = stats1(data.sessions, 100);
                var s2 = stats2(data.sessions);

                console.log(s1);

                writeIntroMessageJS(s1);

                google.charts.setOnLoadCallback(getCumulativePlotDrawer(s1.cumulative, "cumulativePlot"));
                google.charts.setOnLoadCallback(getSubjectTotalsPlotDrawer(s2.subjectTotals, "subjectTotalsPlot"));
            });

            // Load the chart data and setup callbacks to draw plots when we have it.
            loadJSONFile("/json/stats/jgdodson", function (data) {

                // Fill values in the data blocks.
                writeSummaryData(data);


                // - - - Set up call-backs to draw the plots - - - - - - - - - -

                // Only show the current day's overview if the user has studied today.
                if (data.todaysSessions.length > 0) {
                    google.charts.setOnLoadCallback(getTodaysSessionsPlotDrawer(data.todaysSessions, "todaysSessionsPlot"));
                } else {
                    document.getElementById("widt-row").style.display = "none";
                }

                google.charts.setOnLoadCallback(getSlidingAveragePlotDrawer(data.movingAverage, "movingAveragePlot"));
                google.charts.setOnLoadCallback(getProbabilityPlotDrawer(data.probability, "probabilityPlot"));
            })
    </script>

}

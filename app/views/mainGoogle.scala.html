@(title: String)(content: Html)

<!DOCTYPE html>

<html>
    <head>
        <title>@title</title>
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("stylesheets/main.css")">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="shortcut icon" type="image/png" href="@routes.Assets.at("images/favicon.png")">
        <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    </head>
    <body>
            <!-- The content of the page. -->
        @content

        <script>

                // Load the material line chart
                google.charts.load('44', {packages: ['line', 'bar']});

                function getCumulativeGooglePlotDrawer(data, id) {

                    function tmp() {

                        // Convert timestamps to Date objects
                        // Should just send date objects
                        for (var i = 0; i < data.rows.length; i++) {
                            data.rows[i][0] = (new Date(data.rows[i][0]));
                        }

                        var table = new google.visualization.DataTable();

                        var options = {
                            chart: {
                                title: "Cumulative Hours Studied"
                            },
                            legend: {
                                position: 'none'
                            },
                            colors: ['green'],
                            dataOpacity: 0.25
                        };


                        // Add columns to the data table
                        data.columns.forEach(function(curr, i, arr) {
                            table.addColumn(curr[0], curr[1]);
                        });

                        // Add the rows of data to the data table
                        table.addRows(data.rows);

                        var chart = new google.charts.Line(document.getElementById(id));

                        chart.draw(table, options);
                    }

                    return tmp;
                }

                function getSubjectCumulativePlotDrawer(dates, subjectCumulatives) {

                    function tmp() {
                        var data = new google.visualization.DataTable();

                        // Array of subjects for which we have data
                        var subjects = Object.keys(subjectCumulatives);

                        var rows = dates.map(function(date, i, arr) {
                            var row =  [date];

                            return row.concat(subjects.map(function(subject, j, arr) {
                                return subjectCumulatives[subject][i];
                            }));
                        });

                        var options = {
                            chart: {
                                title: "Cumulative Hours Studied Per Subject"
                            },
                            legend: {
                                position: 'none'
                            },
                            //colors: ['green', 'blue', 'red', 'yellow'],
                            explorer: {},
                            dataOpacity: 0.25
                        };

                        // Add a column for the date
                        data.addColumn('date', 'Date');

                        // Add a column for each subject
                        subjects.forEach(function(subject, i, subjects) {
                            data.addColumn('number', subject);
                        });

                        data.addRows(rows);

                        var chart = new google.charts.Line(document.getElementById('subjectCumulativePlot'));

                        chart.draw(data, options);
                    }

                    return tmp;
                }

                // Returns a function that will draw the SubjectTotals plot
                function getSubjectTotalsPlotDrawer(subjects, totals) {

                    function tmp() {
                        var data = new google.visualization.DataTable();

                        var rows = subjects.map(function(curr, i, arr) {
                            return [subjects[i], totals[i]];
                        });

                        var options = {
                            chart: {
                                title: "Total hours studied per subject"
                            },
                            legend: {
                                position: 'none'
                            },
                            bars: 'vertical',
                            colors: ['green'],
                            dataOpacity: 0.25
                        };

                        data.addColumn('string', 'Subject');
                        data.addColumn('number', 'Total Hours');

                        data.addRows(rows);

                        var chart = new google.charts.Bar(document.getElementById('subjectTotalsPlot'));

                        chart.draw(data, options);
                    }

                    return tmp;
                }

                function getSubjectTotalsGooglePlotDrawer(plotData, elementId) {

                    function tmp() {
                        var table = new google.visualization.DataTable();

                        var options = {
                            chart: {
                                title: "Total hours studied per subject"
                            },
                            legend: {
                                position: 'none'
                            },
                            bars: 'vertical',
                            colors: ['green'],
                            dataOpacity: 0.25
                        };


                        // Add columns to the data table
                        plotData.columns.forEach(function(curr, i, arr) {
                            table.addColumn(curr[0], curr[1]);
                        });

                        // Add the rows of data to the data table
                        table.addRows(plotData.rows);


                        var chart = new google.charts.Bar(document.getElementById(elementId));

                        chart.draw(table, options);
                    }

                    return tmp;
                }

                // Returns a function that will draw the AverageSession plot
                function getAverageSessionPlotDrawer(subjects, averages) {

                    function tmp() {
                        var data = new google.visualization.DataTable();

                        var rows = subjects.map(function(curr, i, arr) {
                            return [subjects[i], averages[i]];
                        });

                        var options = {
                            chart: {
                                title: "Average study session length per subject"
                            },
                            legend: {
                                position: 'none'
                            },
                            bars: 'vertical'
                        };

                        data.addColumn('string', 'Subject');
                        data.addColumn('number', 'Average Session Length');

                        data.addRows(rows);

                        var chart = new google.charts.Bar(document.getElementById('averageSessionPlot'));

                        chart.draw(data, options);
                    }

                    return tmp;
                }

                function getProbabilityPlotDrawer(times, probabilities) {

                    function tmp() {
                        var data = new google.visualization.DataTable();

                        var rows = probabilities.map(function(curr, i, arr) {
                            return [times[i], curr];
                        });

                        var options = {
                            chart: {
                                title: "Probability That I'm Programming"
                            },
                            legend: {
                                position: 'none'
                            },
                            colors: ['green'],
                            dataOpacity: 0.25
                        };

                        data.addColumn('timeofday', 'Time');
                        data.addColumn('number', 'Probability');

                        data.addRows(rows);

                        var chart = new google.charts.Line(document.getElementById('probabilityPlot'));

                        chart.draw(data, options);
                    }

                    return tmp;
                }

                // Load the chart data and setup callbacks to plot when we have it.
                d3.json("/stats/1", function(error, json) {

                    if (error) {
                        return console.warn(error);
                    } else {
                        var rawSubjectTotalsGoogleData = json.result.subjectTotalsGoogle.data;
                        var rawCumulativeData = json.result.cumulative.data;
                        var rawCumulativeGoogleData = json.result.cumulativeGoogle.data;
                        var rawAverageSessionData = json.result.averageSession.data;
                        var rawSubjectCumulativeData = json.result.subjectCumulative.data;
                        var rawProbabilityData = json.result.probability.data;

                        console.log(json.result);

                        rawCumulativeData.dates = rawCumulativeData.dates.map(function(curr, i, arr) {
                            return new Date(curr["$date"]);
                        });

                        rawSubjectCumulativeData.dates = rawSubjectCumulativeData.dates.map(function(curr, i, arr) {
                            return new Date(curr["$date"]);
                        });

                        // Set up call-backs to draw the plots
                        google.charts.setOnLoadCallback(getCumulativeGooglePlotDrawer(rawCumulativeGoogleData, "cumulativeGooglePlot"));
                        google.charts.setOnLoadCallback(getSubjectCumulativePlotDrawer(rawSubjectCumulativeData.dates, rawSubjectCumulativeData.values));
                        google.charts.setOnLoadCallback(getSubjectTotalsGooglePlotDrawer(rawSubjectTotalsGoogleData, "subjectTotalsGooglePlot"));
                        google.charts.setOnLoadCallback(getAverageSessionPlotDrawer(rawAverageSessionData.keys, rawAverageSessionData.values));
                        google.charts.setOnLoadCallback(getProbabilityPlotDrawer(rawProbabilityData.times, rawProbabilityData.values))
                    }
                })
        </script>
    </body>
</html>
